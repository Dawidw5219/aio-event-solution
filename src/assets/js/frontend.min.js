jQuery(document).ready(m=>{m("#aio-event-registration-form").on("submit",function(e){e.preventDefault();let t=m(this),o=t.find('button[type="submit"]'),a=o.find(".aio-btn-text"),r=o.find(".aio-btn-loader"),n=m(".aio-registration-messages");n.empty();e=t.serialize()+"&action=aio_register_event";o.prop("disabled",!0),a.hide(),r.show(),m.ajax({url:aioEvents.ajaxUrl,type:"POST",data:e,success:e=>{e.success?(n.html('<div class="aio-message aio-message-success">'+e.data.message+"</div>"),t[0].reset(),m("html, body").animate({scrollTop:n.offset().top-100},500)):n.html('<div class="aio-message aio-message-error">'+e.data.message+"</div>")},error:()=>{n.html('<div class="aio-message aio-message-error">'+aioEvents.i18n.error+": An unexpected error occurred. Please try again.</div>")},complete:()=>{o.prop("disabled",!1),a.show(),r.hide()}})}),m(".event-card").on("mouseenter",function(){m(this).addClass("scale-105")}).on("mouseleave",function(){m(this).removeClass("scale-105")}),m('a[href^="#"]').on("click",function(e){var t=m(this.getAttribute("href"));t.length&&(e.preventDefault(),m("html, body").stop().animate({scrollTop:t.offset().top-100},800))}),m(".aio-event-rsvp-button").on("click",function(e){e.preventDefault();let t=m(this);e=t.data("event-id");m.ajax({url:aioEvents.ajaxUrl,type:"POST",data:{action:"aio_event_rsvp",nonce:aioEvents.nonce,event_id:e},beforeSend:()=>{t.prop("disabled",!0).text("Zapisywanie...")},success:e=>{e.success&&(t.text("Zapisano!").addClass("bg-green-500"),setTimeout(()=>{t.prop("disabled",!1).text("RSVP").removeClass("bg-green-500")},2e3))},error:()=>{t.prop("disabled",!1).text("Błąd - spróbuj ponownie")}})});{let t=setInterval(()=>{let u=document.querySelector("#sib-form");if(u){var e;clearInterval(t),(e=>{let t=e.querySelector('input[name="COUNTRY"], input[id="COUNTRY"]');t?(console.log("[AIO Events] Country field found, detecting country..."),(e=(navigator.language||navigator.userLanguage).split("-")[1]?.toUpperCase())&&2===e.length?(t.value=e,console.log("[AIO Events] Country detected from browser language:",e)):(console.log("[AIO Events] Browser language detection failed, trying IP geolocation..."),fetch("https://ipapi.co/json/").then(e=>e.json()).then(e=>{e.country_code&&2===e.country_code.length?(t.value=e.country_code.toUpperCase(),console.log("[AIO Events] Country detected from ipapi.co:",e.country_code.toUpperCase())):console.log("[AIO Events] ipapi.co did not return valid country code")}).catch(()=>{console.log("[AIO Events] ipapi.co failed, trying alternative API..."),fetch("https://ip-api.com/json/?fields=countryCode").then(e=>e.json()).then(e=>{e.countryCode&&2===e.countryCode.length?(t.value=e.countryCode.toUpperCase(),console.log("[AIO Events] Country detected from ip-api.com:",e.countryCode.toUpperCase())):console.log("[AIO Events] ip-api.com did not return valid country code")}).catch(()=>{console.log("[AIO Events] All country detection methods failed")})}))):console.log("[AIO Events] Country field not found in form")})(u),(e=(e=u).querySelector('input[name="COUNTRY"], input[id="COUNTRY"]'))&&(e=e.closest(".sib-form-block"))&&e.parentElement&&(e.parentElement.style.display="none",console.log("[AIO Events] Country field container hidden"));let c=u.closest("#aio-events-brevo-form-wrapper"),p=c?.dataset.eventId;p?(u.addEventListener("submit",e=>{e.preventDefault(),e.stopPropagation();var e=m(u),t=m(c);let o=e.find('button[type="submit"], input[type="submit"]'),a=t.find(".aio-events-brevo-form-container"),r=t.find(".aio-events-registration-success"),n=t.find(".aio-events-registration-error");var s,i,e=new FormData(u);let l={};for([s,i]of e.entries())"email_address_check"!==s&&(s.endsWith("[]")?(l[s]||(l[s]=[]),l[s].push(i)):l[s]=i);console.log("[AIO Events] Form data:",l),n.hide();let d=o.html();o.prop("disabled",!0).html('<span class="aio-spinner"></span>'),document.getElementById("aio-spinner-style")||m("head").append('<style id="aio-spinner-style">.aio-spinner{display:inline-block;width:16px;height:16px;border:2px solid rgba(255,255,255,0.3);border-top-color:#fff;border-radius:50%;animation:aio-spin 0.8s linear infinite}@keyframes aio-spin{to{transform:rotate(360deg)}}</style>'),m.ajax({url:aioEvents.restUrl+"register?event_id="+p,type:"POST",contentType:"application/json",data:JSON.stringify({event_id:parseInt(p),form_data:l}),success:e=>{var t;e.success||e.already_registered?(a.slideUp(300),(t=l.EMAIL||l.email||"")?r.find(".aio-events-success-email-value").text(t.trim()):r.find(".aio-events-success-email").hide(),r.slideDown(300),m("html, body").animate({scrollTop:r.offset().top-100},500)):(n.find(".aio-events-error-message-text").text(e.message||"Registration failed"),n.slideDown(300),o.prop("disabled",!1).html(d))},error:e=>{e=e.responseJSON?.message||"An error occurred";n.find(".aio-events-error-message-text").text(e),n.slideDown(300),o.prop("disabled",!1).html(d)}})}),console.log("[AIO Events] Form ready (API mode)")):console.error("[AIO Events] Event ID not found")}},100);setTimeout(()=>clearInterval(t),1e4)}let o=()=>{var e=document.querySelector(".aio-events-registration-success");if(e){let a=e.dataset.eventTitle||"";var t=e.dataset.eventSubtitle||"";let r=e.dataset.utcStart||"",n=e.dataset.utcEnd||"";var s=e.dataset.calendarNotice||"The event link will be sent to your registered email shortly before the event starts.";if(r&&n){var i=[];t&&i.push(t),i.push(s);let o=i.join("\n\n");var t=e.querySelector(".aio-calendar-google"),i=(t&&((s=new URL("https://calendar.google.com/calendar/render")).searchParams.set("action","TEMPLATE"),s.searchParams.set("text",a),s.searchParams.set("dates",r+"/"+n),s.searchParams.set("details",o),t.href=s.toString(),t.target="_blank",t.rel="noopener noreferrer"),e.querySelector(".aio-calendar-outlook")),s=(i&&(s=e=>{var t=e.match(/(\d{4})(\d{2})(\d{2})T(\d{2})(\d{2})(\d{2})Z/);return t?`${t[1]}-${t[2]}-${t[3]}T${t[4]}:${t[5]}:${t[6]}Z`:e},(t=new URL("https://outlook.live.com/calendar/0/action/compose")).searchParams.set("subject",a),t.searchParams.set("startdt",s(r)),t.searchParams.set("enddt",s(n)),t.searchParams.set("body",o),i.href=t.toString(),i.target="_blank",i.rel="noopener noreferrer"),e.querySelector(".aio-calendar-ics"));s&&!s.dataset.initialized&&(s.dataset.initialized="true",s.addEventListener("click",e=>{e.preventDefault();var e=(document.title.split(/[|\-–—]/).pop()||location.hostname).trim().replace(/[,;]/g,""),e=["BEGIN:VCALENDAR","VERSION:2.0","PRODID:-//AIO Events//Event Registration//EN","CALSCALE:GREGORIAN","METHOD:PUBLISH","BEGIN:VEVENT","DTSTART:"+r,"DTEND:"+n,"ORGANIZER;CN="+e+":"+location.origin,"SUMMARY:"+a.replace(/,/g,"\\,"),"DESCRIPTION:"+o.replace(/\n/g,"\\n").replace(/,/g,"\\,"),"STATUS:CONFIRMED","UID:"+Date.now()+"@aio-events","END:VEVENT","END:VCALENDAR"].join("\r\n"),e=new Blob([e],{type:"text/calendar;charset=utf-8"}),e=URL.createObjectURL(e),t=document.createElement("a");t.href=e,t.download=a.replace(/[^a-z0-9]/gi,"-").toLowerCase()+".ics",document.body.appendChild(t),t.click(),document.body.removeChild(t),URL.revokeObjectURL(e)}))}}};document.querySelectorAll(".aio-events-registration-success").forEach(t=>{"none"!==t.style.display&&o(),new MutationObserver(e=>{e.forEach(e=>{"attributes"===e.type&&"style"===e.attributeName&&"none"!==t.style.display&&o()})}).observe(t,{attributes:!0,attributeFilter:["style"]})})});