jQuery(document).ready(l=>{l("#aio-event-registration-form").on("submit",function(e){e.preventDefault();let t=l(this),o=t.find('button[type="submit"]'),a=o.find(".aio-btn-text"),s=o.find(".aio-btn-loader"),n=l(".aio-registration-messages");n.empty();e=t.serialize()+"&action=aio_register_event";o.prop("disabled",!0),a.hide(),s.show(),l.ajax({url:aioEvents.ajaxUrl,type:"POST",data:e,success:e=>{e.success?(n.html('<div class="aio-message aio-message-success">'+e.data.message+"</div>"),t[0].reset(),l("html, body").animate({scrollTop:n.offset().top-100},500)):n.html('<div class="aio-message aio-message-error">'+e.data.message+"</div>")},error:()=>{n.html('<div class="aio-message aio-message-error">'+aioEvents.i18n.error+": An unexpected error occurred. Please try again.</div>")},complete:()=>{o.prop("disabled",!1),a.show(),s.hide()}})}),l(".event-card").on("mouseenter",function(){l(this).addClass("scale-105")}).on("mouseleave",function(){l(this).removeClass("scale-105")}),l('a[href^="#"]').on("click",function(e){var t=l(this.getAttribute("href"));t.length&&(e.preventDefault(),l("html, body").stop().animate({scrollTop:t.offset().top-100},800))}),l(".aio-event-rsvp-button").on("click",function(e){e.preventDefault();let t=l(this);e=t.data("event-id");l.ajax({url:aioEvents.ajaxUrl,type:"POST",data:{action:"aio_event_rsvp",nonce:aioEvents.nonce,event_id:e},beforeSend:()=>{t.prop("disabled",!0).text("Zapisywanie...")},success:e=>{e.success&&(t.text("Zapisano!").addClass("bg-green-500"),setTimeout(()=>{t.prop("disabled",!1).text("RSVP").removeClass("bg-green-500")},2e3))},error:()=>{t.prop("disabled",!1).text("Błąd - spróbuj ponownie")}})});{let t=setInterval(()=>{let i=document.querySelector("#sib-form");if(i){clearInterval(t),(e=>{let t=e.querySelector('input[name="COUNTRY"], input[id="COUNTRY"]');t?(console.log("[AIO Events] Country field found, detecting country..."),(e=(navigator.language||navigator.userLanguage).split("-")[1]?.toUpperCase())&&2===e.length?(t.value=e,console.log("[AIO Events] Country detected from browser language:",e)):(console.log("[AIO Events] Browser language detection failed, trying IP geolocation..."),fetch("https://ipapi.co/json/").then(e=>e.json()).then(e=>{e.country_code&&2===e.country_code.length?(t.value=e.country_code.toUpperCase(),console.log("[AIO Events] Country detected from ipapi.co:",e.country_code.toUpperCase())):console.log("[AIO Events] ipapi.co did not return valid country code")}).catch(()=>{console.log("[AIO Events] ipapi.co failed, trying alternative API..."),fetch("https://ip-api.com/json/?fields=countryCode").then(e=>e.json()).then(e=>{e.countryCode&&2===e.countryCode.length?(t.value=e.countryCode.toUpperCase(),console.log("[AIO Events] Country detected from ip-api.com:",e.countryCode.toUpperCase())):console.log("[AIO Events] ip-api.com did not return valid country code")}).catch(()=>{console.log("[AIO Events] All country detection methods failed")})}))):console.log("[AIO Events] Country field not found in form")})(i),(e=(e=i).querySelector('input[name="COUNTRY"], input[id="COUNTRY"]'))&&(e=e.closest(".sib-form-block"))&&e.parentElement&&(e.parentElement.style.display="none",console.log("[AIO Events] Country field container hidden"));let n=i.closest("#aio-events-brevo-form-wrapper"),r=n?n.dataset.eventId:null;if(r){let o=aioEvents.restUrl+"register",a=null,s=!1;i.addEventListener("submit",()=>{a={};var t=i.elements;for(let e=0;e<t.length;e++){var o=t[e];o.name&&"email_address_check"!==o.name&&("checkbox"===o.type||"radio"===o.type?o.checked&&(a[o.name]=o.value):o.value&&(a[o.name]=o.value))}s=!1,console.log("[AIO Events] Form submitted to Brevo, captured data:",a)},!0),new MutationObserver(e=>{var t=i.querySelector(".sib-form-message-panel");t&&"none"!==t.style.display&&0<t.textContent.length&&!t.classList.contains("sib-form-message-panel--error")&&a&&!s&&(s=!0,console.log("[AIO Events] Brevo success detected, sending to our backend..."),l.ajax({url:o+"?event_id="+r,type:"POST",contentType:"application/json",data:JSON.stringify({event_id:parseInt(r),form_data:a}),success:e=>{console.log("[AIO Events] Backend registration:",e.success?"OK":"FAIL");var t=l(n),o=t.find(".aio-events-brevo-form-container"),t=t.find(".aio-events-registration-success");(e.success||e.already_registered)&&(o.slideUp(300),(e=a.EMAIL||a.email||"")?t.find(".aio-events-success-email-value").text(e):t.find(".aio-events-success-email").hide(),t.slideDown(300),l("html, body").animate({scrollTop:t.offset().top-100},500))},error:e=>{console.error("[AIO Events] Backend registration error:",e.responseJSON?.message)}}))}).observe(i,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["style","class"]}),console.log("[AIO Events] Brevo form integration ready (pass-through mode)")}else console.error("AIO Events: Event ID not found in wrapper")}var e},100);setTimeout(()=>{clearInterval(t)},1e4)}let o=()=>{var e=document.querySelector(".aio-events-registration-success");if(e){let a=e.dataset.eventTitle||"";var t=e.dataset.eventSubtitle||"";let s=e.dataset.utcStart||"",n=e.dataset.utcEnd||"";var r=e.dataset.calendarNotice||"The event link will be sent to your registered email shortly before the event starts.";if(s&&n){var i=[];t&&i.push(t),i.push(r);let o=i.join("\n\n");var t=e.querySelector(".aio-calendar-google"),i=(t&&((r=new URL("https://calendar.google.com/calendar/render")).searchParams.set("action","TEMPLATE"),r.searchParams.set("text",a),r.searchParams.set("dates",s+"/"+n),r.searchParams.set("details",o),t.href=r.toString(),t.target="_blank",t.rel="noopener noreferrer"),e.querySelector(".aio-calendar-outlook")),r=(i&&(r=e=>{var t=e.match(/(\d{4})(\d{2})(\d{2})T(\d{2})(\d{2})(\d{2})Z/);return t?`${t[1]}-${t[2]}-${t[3]}T${t[4]}:${t[5]}:${t[6]}Z`:e},(t=new URL("https://outlook.live.com/calendar/0/action/compose")).searchParams.set("subject",a),t.searchParams.set("startdt",r(s)),t.searchParams.set("enddt",r(n)),t.searchParams.set("body",o),i.href=t.toString(),i.target="_blank",i.rel="noopener noreferrer"),e.querySelector(".aio-calendar-ics"));r&&!r.dataset.initialized&&(r.dataset.initialized="true",r.addEventListener("click",e=>{e.preventDefault();var e=(document.title.split(/[|\-–—]/).pop()||location.hostname).trim().replace(/[,;]/g,""),e=["BEGIN:VCALENDAR","VERSION:2.0","PRODID:-//AIO Events//Event Registration//EN","CALSCALE:GREGORIAN","METHOD:PUBLISH","BEGIN:VEVENT","DTSTART:"+s,"DTEND:"+n,"ORGANIZER;CN="+e+":"+location.origin,"SUMMARY:"+a.replace(/,/g,"\\,"),"DESCRIPTION:"+o.replace(/\n/g,"\\n").replace(/,/g,"\\,"),"STATUS:CONFIRMED","UID:"+Date.now()+"@aio-events","END:VEVENT","END:VCALENDAR"].join("\r\n"),e=new Blob([e],{type:"text/calendar;charset=utf-8"}),e=URL.createObjectURL(e),t=document.createElement("a");t.href=e,t.download=a.replace(/[^a-z0-9]/gi,"-").toLowerCase()+".ics",document.body.appendChild(t),t.click(),document.body.removeChild(t),URL.revokeObjectURL(e)}))}}};document.querySelectorAll(".aio-events-registration-success").forEach(t=>{"none"!==t.style.display&&o(),new MutationObserver(e=>{e.forEach(e=>{"attributes"===e.type&&"style"===e.attributeName&&"none"!==t.style.display&&o()})}).observe(t,{attributes:!0,attributeFilter:["style"]})})});