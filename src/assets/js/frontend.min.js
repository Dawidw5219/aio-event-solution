jQuery(document).ready(d=>{d("#aio-event-registration-form").on("submit",function(e){e.preventDefault();let t=d(this),o=t.find('button[type="submit"]'),a=o.find(".aio-btn-text"),n=o.find(".aio-btn-loader"),s=d(".aio-registration-messages");s.empty();e=t.serialize()+"&action=aio_register_event";o.prop("disabled",!0),a.hide(),n.show(),d.ajax({url:aioEvents.ajaxUrl,type:"POST",data:e,success:e=>{e.success?(s.html('<div class="aio-message aio-message-success">'+e.data.message+"</div>"),t[0].reset(),d("html, body").animate({scrollTop:s.offset().top-100},500)):s.html('<div class="aio-message aio-message-error">'+e.data.message+"</div>")},error:()=>{s.html('<div class="aio-message aio-message-error">'+aioEvents.i18n.error+": An unexpected error occurred. Please try again.</div>")},complete:()=>{o.prop("disabled",!1),a.show(),n.hide()}})}),d(".event-card").on("mouseenter",function(){d(this).addClass("scale-105")}).on("mouseleave",function(){d(this).removeClass("scale-105")}),d('a[href^="#"]').on("click",function(e){var t=d(this.getAttribute("href"));t.length&&(e.preventDefault(),d("html, body").stop().animate({scrollTop:t.offset().top-100},800))}),d(".aio-event-rsvp-button").on("click",function(e){e.preventDefault();let t=d(this);e=t.data("event-id");d.ajax({url:aioEvents.ajaxUrl,type:"POST",data:{action:"aio_event_rsvp",nonce:aioEvents.nonce,event_id:e},beforeSend:()=>{t.prop("disabled",!0).text("Zapisywanie...")},success:e=>{e.success&&(t.text("Zapisano!").addClass("bg-green-500"),setTimeout(()=>{t.prop("disabled",!1).text("RSVP").removeClass("bg-green-500")},2e3))},error:()=>{t.prop("disabled",!1).text("Błąd - spróbuj ponownie")}})});{let t=setInterval(()=>{let c=document.querySelector("#sib-form");if(c){clearInterval(t),(e=>{let t=e.querySelector('input[name="COUNTRY"], input[id="COUNTRY"]');t?(console.log("[AIO Events] Country field found, detecting country..."),(e=(navigator.language||navigator.userLanguage).split("-")[1]?.toUpperCase())&&2===e.length?(t.value=e,console.log("[AIO Events] Country detected from browser language:",e)):(console.log("[AIO Events] Browser language detection failed, trying IP geolocation..."),fetch("https://ipapi.co/json/").then(e=>e.json()).then(e=>{e.country_code&&2===e.country_code.length?(t.value=e.country_code.toUpperCase(),console.log("[AIO Events] Country detected from ipapi.co:",e.country_code.toUpperCase())):console.log("[AIO Events] ipapi.co did not return valid country code")}).catch(()=>{console.log("[AIO Events] ipapi.co failed, trying alternative API..."),fetch("https://ip-api.com/json/?fields=countryCode").then(e=>e.json()).then(e=>{e.countryCode&&2===e.countryCode.length?(t.value=e.countryCode.toUpperCase(),console.log("[AIO Events] Country detected from ip-api.com:",e.countryCode.toUpperCase())):console.log("[AIO Events] ip-api.com did not return valid country code")}).catch(()=>{console.log("[AIO Events] All country detection methods failed")})}))):console.log("[AIO Events] Country field not found in form")})(c),(e=(e=c).querySelector('input[name="COUNTRY"], input[id="COUNTRY"]'))&&(e=e.closest(".sib-form-block"))&&e.parentElement&&(e.parentElement.style.display="none",console.log("[AIO Events] Country field container hidden"));let i=c.closest("#aio-events-brevo-form-wrapper"),l=i?i.dataset.eventId:null;if(l){let e=aioEvents.restUrl+"register",n=null,s=!1,a=(c.addEventListener("submit",()=>{n={};var t=c.elements;for(let e=0;e<t.length;e++){var o,a=t[e];a.name&&"email_address_check"!==a.name&&(o=a.name,"checkbox"===a.type?a.checked&&(o.endsWith("[]")?(n[o]||(n[o]=[]),n[o].push(a.value)):n[o]=a.value):"radio"===a.type?a.checked&&(n[o]=a.value):a.value&&(n[o]=a.value))}s=!1,console.log("[AIO Events] Form submitted to Brevo, captured data:",n)},!0),()=>{!s&&n&&(s=!0,console.log("[AIO Events] Sending to backend..."),d.ajax({url:e+"?event_id="+l,type:"POST",contentType:"application/json",data:JSON.stringify({event_id:parseInt(l),form_data:n}),success:e=>{console.log("[AIO Events] Backend:",e.success?"OK":"FAIL");var t=d(i),o=t.find(".aio-events-brevo-form-container"),t=t.find(".aio-events-registration-success");(e.success||e.already_registered)&&(o.slideUp(300),(e=n.EMAIL||n.email||"")?t.find(".aio-events-success-email-value").text(e.trim()):t.find(".aio-events-success-email").hide(),t.slideDown(300),d("html, body").animate({scrollTop:t.offset().top-100},500))},error:e=>{console.error("[AIO Events] Backend error:",e.responseJSON?.message),s=!1}}))}),o=XMLHttpRequest.prototype.open,t=XMLHttpRequest.prototype.send,r=(XMLHttpRequest.prototype.open=function(e,t){return this._aioUrl=t,o.apply(this,arguments)},XMLHttpRequest.prototype.send=function(){return this._aioUrl&&this._aioUrl.includes("sibforms.com")&&this.addEventListener("load",function(){200===this.status&&n&&!s&&(console.log("[AIO Events] Brevo XHR success detected"),a())}),t.apply(this,arguments)},window.fetch);window.fetch=function(e,t){var o=r.apply(this,arguments);return e&&e.toString().includes("sibforms.com")&&o.then(e=>{e.ok&&n&&!s&&(console.log("[AIO Events] Brevo fetch success detected"),a())}).catch(()=>{}),o},console.log("[AIO Events] Brevo form integration ready")}else console.error("AIO Events: Event ID not found in wrapper")}var e},100);setTimeout(()=>{clearInterval(t)},1e4)}let o=()=>{var e=document.querySelector(".aio-events-registration-success");if(e){let a=e.dataset.eventTitle||"";var t=e.dataset.eventSubtitle||"";let n=e.dataset.utcStart||"",s=e.dataset.utcEnd||"";var r=e.dataset.calendarNotice||"The event link will be sent to your registered email shortly before the event starts.";if(n&&s){var i=[];t&&i.push(t),i.push(r);let o=i.join("\n\n");var t=e.querySelector(".aio-calendar-google"),i=(t&&((r=new URL("https://calendar.google.com/calendar/render")).searchParams.set("action","TEMPLATE"),r.searchParams.set("text",a),r.searchParams.set("dates",n+"/"+s),r.searchParams.set("details",o),t.href=r.toString(),t.target="_blank",t.rel="noopener noreferrer"),e.querySelector(".aio-calendar-outlook")),r=(i&&(r=e=>{var t=e.match(/(\d{4})(\d{2})(\d{2})T(\d{2})(\d{2})(\d{2})Z/);return t?`${t[1]}-${t[2]}-${t[3]}T${t[4]}:${t[5]}:${t[6]}Z`:e},(t=new URL("https://outlook.live.com/calendar/0/action/compose")).searchParams.set("subject",a),t.searchParams.set("startdt",r(n)),t.searchParams.set("enddt",r(s)),t.searchParams.set("body",o),i.href=t.toString(),i.target="_blank",i.rel="noopener noreferrer"),e.querySelector(".aio-calendar-ics"));r&&!r.dataset.initialized&&(r.dataset.initialized="true",r.addEventListener("click",e=>{e.preventDefault();var e=(document.title.split(/[|\-–—]/).pop()||location.hostname).trim().replace(/[,;]/g,""),e=["BEGIN:VCALENDAR","VERSION:2.0","PRODID:-//AIO Events//Event Registration//EN","CALSCALE:GREGORIAN","METHOD:PUBLISH","BEGIN:VEVENT","DTSTART:"+n,"DTEND:"+s,"ORGANIZER;CN="+e+":"+location.origin,"SUMMARY:"+a.replace(/,/g,"\\,"),"DESCRIPTION:"+o.replace(/\n/g,"\\n").replace(/,/g,"\\,"),"STATUS:CONFIRMED","UID:"+Date.now()+"@aio-events","END:VEVENT","END:VCALENDAR"].join("\r\n"),e=new Blob([e],{type:"text/calendar;charset=utf-8"}),e=URL.createObjectURL(e),t=document.createElement("a");t.href=e,t.download=a.replace(/[^a-z0-9]/gi,"-").toLowerCase()+".ics",document.body.appendChild(t),t.click(),document.body.removeChild(t),URL.revokeObjectURL(e)}))}}};document.querySelectorAll(".aio-events-registration-success").forEach(t=>{"none"!==t.style.display&&o(),new MutationObserver(e=>{e.forEach(e=>{"attributes"===e.type&&"style"===e.attributeName&&"none"!==t.style.display&&o()})}).observe(t,{attributes:!0,attributeFilter:["style"]})})});