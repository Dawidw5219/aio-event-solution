{# Warning if event is cancelled #}
{% if event_cancelled %}
	<div style="background: #d63638; color: #fff; padding: 12px 15px; margin-bottom: 15px; border-radius: 3px;">
		<strong>‚ö†Ô∏è
			{{ function('__', 'THIS EVENT HAS BEEN CANCELLED', 'aio-event-solution') }}</strong>
		<br>
		<span style="opacity: 0.9;">{{ function('__', 'Cancellation emails were sent to all registrants. This action cannot be undone.', 'aio-event-solution') }}</span>
	</div>
{% endif %}

{# Legend #}
{% if registrations is not empty %}
	<div style="margin-bottom: 10px; font-size: 12px; color: #646970;">
		üîî
		{{ function('__', 'Reminder', 'aio-event-solution') }}
		¬∑ üîó
		{{ function('__', 'Join link', 'aio-event-solution') }}
		¬∑ üì¨
		{{ function('__', 'Follow-up', 'aio-event-solution') }}
	</div>
{% endif %}

{# Registrations table #}
{% if not table_exists %}
	<p class="description">{{ function('__', 'Registrations table does not exist.', 'aio-event-solution') }}</p>
{% elseif registrations is empty %}
	<p class="description">{{ function('__', 'No registrations for this event.', 'aio-event-solution') }}</p>
{% else %}
	<table class="wp-list-table widefat striped" style="table-layout: auto;">
		<thead>
			<tr>
				<th>{{ function('__', 'Name', 'aio-event-solution') }}</th>
				<th>{{ function('__', 'Email', 'aio-event-solution') }}</th>
				<th>{{ function('__', 'Registered', 'aio-event-solution') }}</th>
				<th style="text-align: center;">{{ function('__', 'Attended', 'aio-event-solution') }}</th>
				<th style="text-align: center; width: 35px;">üîî</th>
				<th style="text-align: center; width: 35px;">üîó</th>
				<th style="text-align: center; width: 35px;">üì¨</th>
			</tr>
		</thead>
		<tbody>
			{% for registration in registrations %}
				<tr>
					<td>
						<strong>{{ registration.name|default('‚Äî') }}</strong>
					</td>
					<td>
						<a href="mailto:{{ registration.email|default('') }}">{{ registration.email|default('‚Äî') }}</a>
					</td>
					<td>
						{% if registration.registered_at %}
							{{ function('date_i18n', 'd/m H:i', function('strtotime', registration.registered_at)) }}{% else %}‚Äî
						{% endif %}
					</td>
					<td style="text-align: center;">
						{% if registration.clicked_join_link %}
							{{ function('__', 'Yes', 'aio-event-solution') }}
						{% else %}
							{{ function('__', 'No', 'aio-event-solution') }}
						{% endif %}
					</td>
					<td style="text-align: center;">
						{% if registration.reminder_email_sent_at %}
							<span style="color: #00a32a;">‚úì</span>
						{% else %}
							<span style="color: #ddd;">‚Äì</span>
						{% endif %}
					</td>
					<td style="text-align: center;">
						{% if registration.join_email_sent_at %}
							<span style="color: #00a32a;">‚úì</span>
						{% else %}
							<span style="color: #ddd;">‚Äì</span>
						{% endif %}
					</td>
					<td style="text-align: center;">
						{% if registration.followup_email_sent_at %}
							<span style="color: #00a32a;">‚úì</span>
						{% else %}
							<span style="color: #ddd;">‚Äì</span>
						{% endif %}
					</td>
				</tr>
			{% endfor %}
		</tbody>
	</table>

	<div style="margin-top: 15px;">
		<button type="button" class="button button-secondary" id="aio-export-registrations-csv" data-event-id="{{ post_id }}">
			{{ function('__', 'Export to CSV', 'aio-event-solution') }}
		</button>
	</div>
{% endif %}

{# Cancel Event Section #}
{% if not event_cancelled %}
	<div style="margin-top: 50px; padding-top: 20px; border-top: 1px solid #ddd;">
		<h4 style="margin: 0 0 10px 0;">{{ function('__', 'Cancel Event', 'aio-event-solution') }}</h4>
		<p class="description" style="margin-bottom: 15px;">
			{{ function('__', 'This will send a cancellation email to all registered participants and permanently mark this event as cancelled.', 'aio-event-solution') }}
		</p>

		<div style="margin-bottom: 15px;">
			<label for="aio_cancel_template" style="display: block; margin-bottom: 5px; font-weight: 600;">
				{{ function('__', 'Cancellation email template:', 'aio-event-solution') }}
			</label>
			<select id="aio_cancel_template" style="width: 100%; max-width: 400px;">
				<option value="">‚Äî
					{{ function('__', 'Do not send email (just cancel)', 'aio-event-solution') }}
					‚Äî</option>
				{% for template in templates %}
					<option value="{{ template.id }}">{{ template.name }}</option>
				{% endfor %}
			</select>
		</div>

		<button type="button" class="button button-secondary" id="aio-cancel-event-btn" data-event-id="{{ post_id }}">
			{{ function('__', 'Cancel Event', 'aio-event-solution') }}
		</button>
		<span class="description" style="margin-left: 10px;">
			{{ function('__', 'This action cannot be undone!', 'aio-event-solution') }}
		</span>

		<div id="aio-cancel-event-message" style="margin-top: 10px; display: none;"></div>
	</div>
{% endif %}

<script>
	(function ($) {
$('#aio-export-registrations-csv').on('click', function () {
var eventId = $(this).data('event-id');
var url = ajaxurl + '?action=aio_export_registrations_csv&event_id=' + eventId + '&nonce=  {{ function("wp_create_nonce", "aio_export_csv") }}';
window.location.href = url;
});

$('#aio-cancel-event-btn').on('click', function () {
var $button = $(this);
var $message = $('#aio-cancel-event-message');
var eventId = $button.data('event-id');
var templateId = $('#aio_cancel_template').val();

if (!confirm('{{ function("__", "Are you sure you want to cancel this event? This action CANNOT be undone!", "aio-event-solution")|e("js") }}')) {
return;
}

$button.prop('disabled', true).text('{{ function("__", "Cancelling...", "aio-event-solution")|e("js") }}');

$.ajax({
url: ajaxurl,
type: 'POST',
data: {
action: 'aio_cancel_event',
event_id: eventId,
template_id: templateId,
nonce: '{{ cancel_nonce }}'
},
success: function (response) {
if (response.success) {
$message.html('<span style="color: #00a32a;">‚úì ' + response.data.message + '</span>').show();
setTimeout(function () {
location.reload();
}, 1500);
} else {
$message.html('<span style="color: #d63638;">‚úó ' + (
response.data.message || 'Error'
) + '</span>').show();
$button.prop('disabled', false).text('{{ function("__", "Cancel Event", "aio-event-solution")|e("js") }}');
}
},
error: function () {
$message.html('<span style="color: #d63638;">‚úó Server error</span>').show();
$button.prop('disabled', false).text('{{ function("__", "Cancel Event", "aio-event-solution")|e("js") }}');
}
});
});
})(jQuery);
</script>
